---
layout:     post
title:   "Create Perfect Kubernetes Cluster Using Kops On Cloud"
date:       2021-08-06 4:00:00
author:     "Thaung Htike Oo"
image: 21.jpg
categories: kubernetes
catalog: true
tags:
    - Kubernetes
    - AWS
---

<h2> KOPS မိတ်ဆက် </h2>

စာမရေးဖြစ်တာလည်း အတော်ကြာခဲ့ပါပြီ။ ဒါကြောင့် ဒီအပတ်မှာ တစ်ခုလောက်တော့ပြန်ရေးမယ်ဆိုပြီးဆုံးဖြတ်လိုက်တဲ့အချိန်မှာ kops အကြောင်းကိုစဥ်းစားမိတာနဲ့ ရေးမယ်လို့ဆုံးဖြတ်လိုက်တာပါ။ ကျွန်တော်တို့တွေဟာ kubernetes cluster တွေကို ပုံစံအမျိုးမျိုး tools အမျိုးမျိုး နဲ့ on-prem မှာကော cloud ပေါ်မှာပါ deploy လုပ်လာကြပါတယ်။ kops ဆိုတာကလည်း kubernetes cluster တွေကို cloud ပေါ်မှာ create ဖို့အတွက် သုံးမယ့် tool တစ်ခုဖြစ်ပါတယ်။ cloud provider တွေရဲ့ vm တွေပေါ်မှာ kops ကိုအသုံးပြုပြီး kubernetes cluster တွေအလွယ်တကူ create လုပ်နိုင်ပါတယ်။ AKS ၊ EKS ၊ GKE တို့ကတော့ cloud provider အသီးသီးကနေ managed လုပ်ပေးထားတာဖြစ်ပြီး kops ကတော့ ကျွန်တော်တို့ကိုယ်တိုင် managed လုပ်ပေးရမှာဖြစ်ပါတယ်။ အခုချိန်မှာတော့ AWS ကတော့ kops ကို official support ပေးထားပြီး ကျန်တဲ့ cloud provider တွေကတော့ aplha beta စသည့်ဖြင့်အသီးသီး support လုပ်ထားပးပါတယ်။ ဒါကြောင့် ဒီနေ့မှာ ကျွန်တော်က AWS ပေါ်မှာ kops ကိုသုံးပြီး kubernetes cluster တွေ create တဲ့အကြာင်းကို ဆွေးနွေးသွားပါမယ်။

<h2> Install Kops & Kubectl </h2>

ပထမဆုံးအနေနဲ့ kops နဲ့ kubectl ကို install လုပ်ဖို့လိုပါတယ်။ 

```bash
curl -Lo kops https://github.com/kubernetes/kops/releases/download/$(curl -s https://api.github.com/repos/kubernetes/kops/releases/latest | grep tag_name | cut -d '"' -f 4)/kops-linux-amd64
chmod +x kops
sudo mv kops /usr/local/bin/kops
sudo snap install kubectl --classic
```
<h2> Getting Started Kops On AwS </h2>

kops နဲ့ cluster တွေကို CREATE မလုပ်ခင်မှာ အရင်ဆုံး aws account မှာလိုအပ်တာတွေကို လုပ်ပေးရပါမယ်။ iam user တစ်ယောက် create ပြီး အောက်ကလိုအပ်တဲ့ policy တွေ ADD ပေးရပါဦးမယ်။ အသေးစိတ်ကို [official doc](https://kops.sigs.k8s.io/getting_started/aws/) မှာကြည့်နိုင်ပါတယ်ခင်ဗျာ။

```bash
AmazonEC2FullAccess
AmazonRoute53FullAccess
AmazonS3FullAccess
IAMFullAccess
AmazonVPCFullAccess
```
ကျွန်တော်ကတော့ root user ကိုပဲသုံးမှာဆိုတော့ IAM user တစ်ယောက် create မလုပ်တော့ပါဘူး။ ကျွန်တော့်ရဲ့ terminal မှာ aws ကို access လုပ်ဖို့အတွက် configure လုပ်ပေးရပါမယ်။ 

```bash
sudo apt install awscli -y
aws configure
```
<h3> Configure DNS </h3>

kops မှာ kubernetes cluster တွေ create ဖို့ဆို cluster ရဲ့ dns records တွေကို store လုပ်ဖို့ route53 မှာ hosted zone တစ်ခုဆောက်ပေးရပါမယ်။ အဲ့လို့ dns hosted zone တစ်ခုမသုံးချင်ဘူးရင်တော့ gossip dns ကို သုံးနိုင်ပါတယ်။ gossip-based cluster တွေရဲ့ domain က k8s.local နဲ့အသုံးသတ်ရပါတယ်။  gossip dns ကိုသုံးမယ်ဆိုရင် domain မလိုပါဘူး။ အသေးစိတ်ကိုတော့ [ဒီမှာ](https://kops.sigs.k8s.io/gossip/) လေ့လာနိုင်ပါတယ်။ DNS configure လုပ်တဲ့နေရာမှာ official doc မှာရေးထားတဲ့အတိုင်း (၃)နည်းရှိပါတယ်။ ကျွန်တော်ကတော့ တတိယနည်းဖြစ်တဲ့ Subdomain for clusters in route53, leaving the domain at another registrar နည်းကိုသုံးမှာဆိုတော့ Route 53 မှာ hosted zone တစ်ခုဆောက်လိုက်ပါမယ်။ 

![route53](https://raw.githubusercontent.com/thaunghtike-share/thaunghtike-share.github.io/master/images/r53.png)

route 53 မှာ hosted zone တစ်ခုဆောက်ပြီးရင် godaddy က ကျွန်တော့်ရဲ့ domain မှာ nameserver တွေမှာ route53 က ns (၄)ခုကို add ပေးရပါမယ်။

![nsr53](https://raw.githubusercontent.com/thaunghtike-share/thaunghtike-share.github.io/master/images/nsr5.png)

<h2> Cluster State storage </h2>

cluster နဲ့ ဆိုင်တဲ့ information တွေ store လုပ်ဖို့အတွက် s3 bucket တစ်ခု create ရပါမယ်။ ကျွန်တော်ကတော့ tho-demo-kops လို့နာမည်ပေးလိုက်ပါတယ်။ bukcet အတွက် version enabled လုပ်ပေးခဲ့ရပါမယ်။

```bash
aws s3api create-bucket \
    --bucket tho-demo-kops \
    --region us-east-1  --versioning-configuration Status=Enabled
```
<h2> Creating your first cluster </h2>

iam user ၊ hosted zone နဲ့ s3 bucket တွေ အားလုံး create ပြီးသွားပြီဆိုရင်တော့ kubernetes cluster တစ်ခုကို create လို့ရပါပြီ။ cluster အတွက် dns zone ၊ kubernetes version ၊ master node count ၊ worker node count ၊ master node size ၊ worker node size စသည့် flag တွေမဖြစ်မနေထည့်ပေးရပါမယ်။ NAME နဲ့ KOPS_STATE_STORE ဆိုတဲ့ inveroment variables (၂)ခုကိုတော့ မဖြစ်မနေ သတ်မှတ်ပေးဖို့လိုပါတယ်။ cluster name ကတော့ ကျွန်တော့်ရဲ့ hosted zone ကိုပေးလိုက်ပြီး state store ကိုတော့ ခုဏက create ခဲ့တဲ့ bucket ကိုသုံးပါမယ်။

```bash
export NAME=k8s.thaunghtikeoo.info
export KOPS_STATE_STORE=s3://tho-demo-kops
```
env var တွေသတ်မှတ်ပြီးရင် master နဲ့ worker node တွေအတွက်  ssh key pair ကို create ပေးရပါမယ်။
