---
layout:     post
title:   "Kubernetes Pods Health Check Using Probes"
date:       2021-08-31 15:13:18 +0200
image: 22.jpg
tags:
    - Kubernetes
categories: kubernetes
---   

<h2> Probes မိတ်ဆက် </h2>

အားလုံးပဲ ကျွန်တော့်ရဲ့ sharing blog ကနေ ပြန်လည်ကြိုဆိုလိုက်ပါတယ်။ ဒီအပတ်မှာ k8s ရဲ့ probes တွေအကြောင်းကို sharing လုပ်ပေးသွားမှာဖြစ်ပါတယ်။ Kubernetes မှာ pods တွေရဲ့ health status ကိုသိဖို့အတွက်ဆို probes တွေကိုအသုံးပြုပြီး စစ်လို့ရပါတယ်။ အခုလက်ရှိအချိန်ထိ kubernetes မှာ Startup Probe ၊ Liveness Probe နဲ့ Readiness Probes ဆိုပြီးအခြေခံအားဖြင့် probe (၃)ခုရှိပါတယ်။ probe တွေကို သုံးခြင်းဖြင့် pod ထဲမှာရှိတဲံ container တွေက RUNNING ဖြစ်နေပြီလား traffic တွေကို လက်ခံဖို့အတွက် ready ဖြစ်နေပြီလားဆိုတာကို သိနိုင်ပါတယ်။ probe တစ်ခုချင်းစီရဲ့အကြောင်းကိုအောက်မှာ ရှင်းပြပေးသွားပါမယ်။

Probes တွေအသုံးပြုတဲ့အခါမှာ kubelet ရဲ့ role က အဓိကနေရာတစ်ခုကနေပါဝင်နေပါတယ်။ အားလုံးသိပြီးတဲ့အတိုင်း kubelet က pods တွေ run ဖို့အတွက် node agent အနေနဲ့တာဝန်ယူထားပါတယ်။  

<h2> Types of Probes </h2>
<ul>
    <li> Liveness Probe  </li>
    <li> Readiness Probe  </li>
    <li> Startup Probe  </li>
</ul>    

<h2> Liveness Probe </h2>

Liveness Probe ဆိုတာက container တွေကို restart လုပ်ဖို့အတွက်သုံးရတာပါ။ liveness ဆိုတဲ့အတိုင်းပဲ container က running ဖြစ်နေလားဆိုတာသိရဖို့အတွက်သုံးတာပါ။ အချိန်အကြာကြီး run နေတဲ့ applications တွေမှာ တစ်ခါတစ်ရံ unresponsive ဖြစ်သွားတာပဲဖြစ်ဖြစ် အကြောင်းတင်ခုခုကြောင့် broken ဖြစ်သွားတာပဲဖြစ်ဖြစ် အဲ့လိုအချိန်မျိုးမှာဆို container တွေကို restart ချပေးဖို့လိုတဲ့အခါ liveness probe ကိုသုံးရပါတယ်။ liveness probe ကိုသာမသုံးထားဘူးဆိုရင် container သူ့အလိုလိုပြန်အလုပ်လုပ်လာတဲ့အထိ စောင့်ရမယ်။ လုံးဝပြန်တက်မလာတော့တာမျိုးလည်းဖြစ်နိုင်ပါတယ်။ container ကို restart လုပ်ပေးမယ်ဆို availability ပိုကောင်းလာမှာပါ။ အောက်က pod yaml ကိုတစ်ချက်ကြည့်ပါ။

```yaml
apiVersion: v1
kind: Pod
metadata:
  labels:
    test: liveness
  name: nginx
spec:
  containers:
  - name: liveness
    image: nginx
    ports:
    - containerPort: 80
    livenessProbe:
      exec:
        command:
        - cat
        - /usr/share/nginx/html/index.html
      initialDelaySeconds: 5
      periodSeconds: 5
```      
container ကတော့ nginx နဲ့ပဲမြင်သာအောင်စမ်းပြထားပါတယ်။ initialDelaySeconds ဆိုတာက nginx container start ဖြစ်ပြီဆိုတာနဲ့ 5 second စောင့်ပြီး probe ကို periodSeconds ဆိုတဲ့ 5 second တိုင်းတစ်ခါစစ်နေတော့မှာပါ။ nginx default page ကို ဖတ်လို့ရရင် container running ဖြစ်နေမှာဖြစ်ပြီး Success return ပြန်ပါမယ်။ အကယ်၍ /usr/share/nginx/html/index.html သာ မရှိတော့ဘူးဆိုရင် liveness probe က failed ဖြစ်သွားပါမယ်။ failed ဖြစ်သွားတဲ့အခါ kubelet ကနေပြီးတော့ nginx container ကို restart  ချပါမယ်။ ပိုမြင်သာသွားအောင် lab လေးနဲ့တွဲပြလိုက်ပါမယ်။

```bash
thaunghtikeoo@thaunghtikeoo:~$ k get all
NAME        READY   STATUS    RESTARTS   AGE
pod/nginx   1/1     Running   0          7m56s

NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.152.183.1   <none>        443/TCP   15m
```
အခုချိန်မှာ nginx pod လေးက running ဖြစ်နေတုန်းပါ။ events ကိုကြည့်ရင်လည်း အောက်ကအတိုင်း  တွေ့ရမှာပါ။ 

```bash
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  8m20s  default-scheduler  Successfully assigned default/nginx to thaunghtikeoo
  Normal  Pulling    8m20s  kubelet            Pulling image "nginx"
  Normal  Pulled     8m17s  kubelet            Successfully pulled image "nginx" in 3.02171608s
  Normal  Created    8m17s  kubelet            Created container liveness
  Normal  Started    8m17s  kubelet            Started container liveness
```
အောက်အတိုင်း index.html ကို ခေါ်ကြည့်ရင်လည်း file က ရှိနေပါသေးတယ်။ 

```bash
thaunghtikeoo@thaunghtikeoo:~$ k exec nginx -- cat /usr/share/nginx/html/index.html
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
```
အခုချိန်ထိ ရှင်းပြခဲ့တာက liveness probe success ဖြစ်တာပဲရှိပါသေးတယ်။ failed ဖြစ်တဲ့အကြောင်းမပါသေးပါဘူး။ ဒါဆိုအခုပဲ failed ဖြစ်တာကို စမ်းဖို့အတွက် ကျွန်တော် index.html ကို manual ဝင်ဖြတ်လိုက်ပါမယ်။ တကယ့် real time မှာ တစ်ခုခု broken ဖြစ်သွားတဲ့အခါ container restart တာကိုပြချင်တာပါ။ 

```bash
thaunghtikeoo@thaunghtikeoo:~$ k exec nginx -- rm -rf /usr/share/nginx/html/index.html

thaunghtikeoo@thaunghtikeoo:~$ k exec nginx -- cat /usr/share/nginx/html/index.html
cat: /usr/share/nginx/html/index.html: No such file or directory
command terminated with exit code 1
```
ဒါဆို index.html ကို ဖြတ်လိုက်ပါပြီ။ liveness probe ကစပြီး failed ဖြစ်ပါတော့မယ်။ အဲ့အချိန်မှာ pods ရဲ့ events တွေကိုကြည့်လိုက်ရင် liveness probe failed ဆိုပြီးအောက်ကအတိုင်းပြမှာပါ။

```bash
Events:
  Type     Reason     Age                From               Message
  ----     ------     ----               ----               -------
  Normal   Scheduled  19m                default-scheduler  Successfully assigned default/nginx to thaunghtikeoo
  Normal   Pulled     19m                kubelet            Successfully pulled image "nginx" in 3.02171608s
  Warning  Unhealthy  86s (x3 over 96s)  kubelet            Liveness probe failed: cat: /usr/share/nginx/html/index.html: No such file or directory
  Normal   Killing    86s                kubelet            Container liveness failed liveness probe, will be restarted
```
ခဏကြာတော့ pod မှာ restart (1)ဆိုပြီးတွေ့ရမှာဖြစ်ပါတယ်။ ဆိုလိုတာက kubelet ကနေပြီးတော့ container ကို restart ပြန်လုပ်ပေးတာဖြစ်ပါတယ်။ 

```bash
thaunghtikeoo@thaunghtikeoo:~$ k get all
NAME        READY   STATUS    RESTARTS   AGE
pod/nginx   1/1     Running   1          19m

NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.152.183.1   <none>        443/TCP   26m
```
events ကိုပြန်ကြည့်ရင်လည်း image pull ပြန်လုပ်တာကိုအောက်ကအတိုင်းတွေ့ရမှာဖြစ်ပါတယ်။

```bash
Events:
  Type     Reason     Age                From               Message
  ----     ------     ----               ----               -------
  Normal   Scheduled  19m                default-scheduler  Successfully assigned default/nginx to thaunghtikeoo
  Normal   Pulled     19m                kubelet            Successfully pulled image "nginx" in 3.02171608s
  Warning  Unhealthy  86s (x3 over 96s)  kubelet            Liveness probe failed: cat: /usr/share/nginx/html/index.html: No such file or directory
  Normal   Killing    86s                kubelet            Container liveness failed liveness probe, will be restarted
  Normal   Pulling    86s (x2 over 19m)  kubelet            Pulling image "nginx"
  Normal   Pulled     77s                kubelet            Successfully pulled image "nginx" in 8.658136386s
  Normal   Created    77s (x2 over 19m)  kubelet            Created container liveness
  Normal   Started    77s (x2 over 19m)  kubelet            Started container liveness
```
index.html ကလည်း exit ဖြစ်နေတာကိုတွေ့ရမှာပါ။

```bash
thaunghtikeoo@thaunghtikeoo:~$ k exec nginx -- cat /usr/share/nginx/html/index.html
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>
<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
```



