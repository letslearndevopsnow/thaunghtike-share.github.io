---
layout:     post
title:   "Backup And Restore Kubernetes Resources Using Velero"
date:       2021-09-09 15:13:18 +0200
image: 6.jpg
tags:
    - Kubernetes
categories: kubernetes
---            

<h2> Introduction </h2>

We have to back up the applications which are deployed on a Kubernetes cluster to protect loss. There are many tools to backup and restore k8s resources like velero and Kasten 10. If you have backups, it is easy to restore if the cluster goes down or an application crashes accidentally. You can also back up k8s resources and persistent volumes on Kubernetes clusters. You can use velero not only to back up and restore but also to migrate clusters. For example, to migrate the PVC used for the database in the on-prem k8s cluster, you have to export database dumps from the old cluster at first then import the dumped databases to the database in the new cluster. Velero can solve these problems. When k8s clusters are migrated, there are limitations to migrating to PVC. The storage class of the PVC which you want to backup must be in the new cluster. You have to use same common bucket if you want to migrate resources among multiple clusters. Velero does not support host path PVC. 

<h2> Installation </h2>

Firstly you have to create a kubernetes cluster. I will use azure aks cluster with two worker nodes for this demo. So, let me create an aks cluster.

```bash
thaunghtikeoo@thaunghtikeoo:~$ az group create --name demo --location eastus && az aks create --name demo -g demo --location eastus --node-count 2 
```
My k8s cluster is ready now. Check the status of cluster's nodes.

```bash
thaunghtikeoo@thaunghtikeoo:~$ kubectl get nodes 
NAME                                STATUS   ROLES   AGE    VERSION
aks-nodepool1-32685854-vmss000000   Ready    agent   112s   v1.20.9
aks-nodepool1-32685854-vmss000001   Ready    agent   2m1s   v1.20.9
```
Then you have to install velero cli binary on your machine. You can download velero cli [here](https://github.com/vmware-tanzu/velero/releases/tag/v1.6.3). After downloading binary, extract the tarball and move velero to /usr/local/bin.

```bash
thaunghtikeoo@thaunghtikeoo:~$ wget https://github.com/vmware-tanzu/velero/releases/download/v1.6.3/velero-v1.6.3-linux-amd64.tar.gz

thaunghtikeoo@thaunghtikeoo:~$ tar xzvf velero-v1.6.3-linux-amd64.tar.gz && chmod +x velero-v1.6.* && sudo mv velero-v1.6.3-linux-amd64/velero /usr/local/bin/velero
```
<h2> Velero supported providers </h2>

Velero supports a variety of storage providers for different backup and snapshot operations. You can check [here](https://velero.io/docs/v1.6/supported-providers) to see list of supported providers. I will use Amazon S3 bucket today. You can use Azure Blog Storage or Google Cloud Storage as you want. Before installing Velero on kubernetes cluster, create a S3 bucket which will be used to store backup and restore tar files.

```bash
BUCKET=tho-velero-demo
REGION=us-east-1
aws s3api create-bucket \
    --bucket $BUCKET \
    --region $REGION 
```
Now, I'm ready to install VELERO on my aks cluster. 

```bash
thaunghtikeoo@thaunghtikeoo:~$ velero install --use-restic --provider aws --plugins velero/velero-plugin-for-aws:v1.2.1 --bucket $BUCKET --backup-location-config region=$REGION --snapshot-location-config region=$REGION --secret-file ~/.aws/credentials 
```
You will get like the outputs below after a couple of minutes.

```bash
Deployment/velero: attempting to create resource
Deployment/velero: attempting to create resource client
Deployment/velero: created
Velero is installed! ⛵ Use 'kubectl logs deployment/velero -n velero' to view the status.
```
You will see restic daemonset here. So, what's restic? Let me explain a little bit about restic.

<h2> Restic </h2>

Velero supports backing up and restoring Kubernetes volumes using a free open-source backup tool called restic. Velero allows you to take snapshots of persistent volumes as part of your backups if you’re using one of the supported cloud providers’ block storage offerings (Amazon EBS Volumes, Azure Managed Disks, Google Persistent Disks). It means if you are using one of the cloud storage providers such as EBS or Azure Disks , it's not a problem why you can create snapshots manually. Then you can create pvc with new volumes which are created from snapshots. However, if you want to use storage platform that doesn’t have a native snapshot concept such as ( Azure File, EFS ), restic might be for you. If you don't use restic, velero only restores pvc name without restoring data inside volume.

<h3> Install restic </h3>

To install restic, use the --use-restic flag in the velero install command. See the install overview for more details on other flags for the install command.

```bash
velero install --use-restic
```

